---
title: "Modelos de Datos"
description: "Estructura detallada de las entidades principales del sistema Paso R√°pido"
---

# Modelos de Datos

Esta secci√≥n explica en detalle la estructura de datos del sistema Paso R√°pido, incluyendo las entidades principales, sus relaciones y prop√≥sitos espec√≠ficos.

## Arquitectura de Datos

### Principios Fundamentales

<CardGroup cols={2}>
<Card title="Multi-Tenancia" icon="building">
**Aislamiento por Organizaci√≥n**

Cada organizaci√≥n tiene sus datos completamente separados mediante el campo `org_id` en todas las tablas principales.

- Seguridad garantizada entre organizaciones
- Escalabilidad horizontal
- Gesti√≥n independiente de datos
</Card>

<Card title="Trazabilidad" icon="clock">
**Auditor√≠a Completa**

Todos los cambios importantes se registran con timestamps y usuarios responsables.

- Campos `created_at` y `updated_at`
- Historial de validaciones
- Registro de acciones de usuarios
</Card>
</CardGroup>

## Entidades Principales

### 1. Organizaciones

<Tabs>
<Tab title="Estructura">
```sql
organizations {
  id: UUID (Primary Key)
  name: TEXT
  avatar_url: TEXT
  created_at: TIMESTAMP
  updated_at: TIMESTAMP
  karma_api_url: TEXT
  karma_username: TEXT
  karma_password_encrypted: TEXT
}
```

**Prop√≥sito**: Entidad ra√≠z que representa cada empresa cliente del sistema.
</Tab>

<Tab title="Campos Detallados">
<ParamField path="id" type="UUID" required>
Identificador √∫nico de la organizaci√≥n. Se genera autom√°ticamente.
</ParamField>

<ParamField path="name" type="TEXT" required>
Nombre comercial de la empresa (ej: "Transportes ABC S.A.").
</ParamField>

<ParamField path="avatar_url" type="TEXT">
URL del logo o imagen corporativa para personalizaci√≥n de la interfaz.
</ParamField>

<ParamField path="karma_api_url" type="TEXT">
URL del servidor ERM Karma espec√≠fico de la organizaci√≥n para obtener datos GPS.
</ParamField>

<ParamField path="karma_username" type="TEXT">
Usuario para autenticaci√≥n con la API de ERM Karma.
</ParamField>

<ParamField path="karma_password_encrypted" type="TEXT">
Contrase√±a encriptada para la API de ERM Karma (nunca se almacena en texto plano).
</ParamField>
</Tab>

<Tab title="Relaciones">
**Una organizaci√≥n puede tener**:
- M√∫ltiples usuarios (tabla `org_members`)
- M√∫ltiples veh√≠culos (tabla `cars`)
- M√∫ltiples proyectos (tabla `projects`)
- M√∫ltiples cargos de peaje (tabla `toll_charges`)
- M√∫ltiples asignaciones de tags (tabla `tag_assignments`)

**Pol√≠ticas de seguridad**:
- Los usuarios solo pueden ver datos de sus organizaciones
- Eliminaci√≥n en cascada protege la integridad de datos
</Tab>
</Tabs>

### 2. Usuarios y Membres√≠as

<Tabs>
<Tab title="Estructura">
```sql
org_members {
  org_id: UUID (FK ‚Üí organizations.id)
  user_id: UUID (FK ‚Üí auth.users.id)
  role: TEXT (OrgAdmin|Dispatcher|Analyst|Driver|ReadOnly)
  created_at: TIMESTAMP
  updated_at: TIMESTAMP
  PRIMARY KEY (org_id, user_id)
}
```

**Prop√≥sito**: Define qu√© usuarios pertenecen a cada organizaci√≥n y con qu√© nivel de acceso.
</Tab>

<Tab title="Roles Disponibles">
<AccordionGroup>
<Accordion title="OrgAdmin - Administrador">
**Permisos completos**:
- ‚úÖ Gestionar usuarios y roles
- ‚úÖ Configurar integraciones API
- ‚úÖ Acceso a todos los m√≥dulos
- ‚úÖ Generar cualquier reporte
- ‚úÖ Modificar configuraciones del sistema
- ‚úÖ Ver informaci√≥n financiera y estad√≠sticas

**Casos de uso**: CEO, CTO, Gerente General
</Accordion>

<Accordion title="Analyst - Analista">
**Permisos operativos**:
- ‚úÖ Ejecutar validaciones de cargos
- ‚úÖ Revisar casos sospechosos
- ‚úÖ Aprobar/rechazar cargos manualmente
- ‚úÖ Generar reportes operativos
- ‚úÖ Ver dashboards anal√≠ticos
- ‚ùå Modificar configuraciones del sistema

**Casos de uso**: Analista de Costos, Controller, Jefe de Operaciones
</Accordion>

<Accordion title="Dispatcher - Despachador">
**Permisos de flota**:
- ‚úÖ Ver informaci√≥n de veh√≠culos
- ‚úÖ Consultar cargos de peajes
- ‚úÖ Generar reportes b√°sicos
- ‚úÖ Gestionar asignaciones de tags
- ‚ùå Ejecutar validaciones
- ‚ùå Modificar estados de validaci√≥n

**Casos de uso**: Despachador, Coordinador de Flota
</Accordion>

<Accordion title="ReadOnly - Solo Lectura">
**Permisos de consulta**:
- ‚úÖ Ver dashboards
- ‚úÖ Consultar reportes generados
- ‚úÖ Acceso a informaci√≥n hist√≥rica
- ‚ùå Cualquier tipo de modificaci√≥n
- ‚ùå Generar nuevos reportes

**Casos de uso**: Gerencia, Auditor√≠a Externa, Consultores
</Accordion>
</AccordionGroup>
</Tab>
</Tabs>

### 3. Veh√≠culos

<img
  src="/images/vehicle_pane.png"
  alt="Panel detallado de informaci√≥n del veh√≠culo"
/>

<Tabs>
<Tab title="Estructura">
```sql
cars {
  car_id: BIGINT (Primary Key)
  device_id: BIGINT
  project_id: BIGINT (FK ‚Üí projects.project_id)
  time_zone: TEXT
  car_number: TEXT
  license_plate: TEXT
  car_title: TEXT
  car_type: TEXT
  sub_type: TEXT
  car_year: TEXT
  car_color: TEXT
  sim_imsi: TEXT
  sim_phone: TEXT
  karma_video_data: TEXT
  fetch_timestamp: TIMESTAMP
  org_id: UUID (FK ‚Üí organizations.id)
}
```

**Prop√≥sito**: Representa cada veh√≠culo de la flota con su informaci√≥n t√©cnica y administrativa.
</Tab>

<Tab title="Campos Detallados">
<ParamField path="car_id" type="BIGINT" required>
Identificador √∫nico del veh√≠culo en el sistema ERM Karma. Este ID se sincroniza autom√°ticamente.
</ParamField>

<ParamField path="device_id" type="BIGINT">
ID del dispositivo GPS instalado en el veh√≠culo. Usado para correlacionar datos de telemetr√≠a.
</ParamField>

<ParamField path="project_id" type="BIGINT">
Referencia al proyecto al que pertenece el veh√≠culo (permite agrupaci√≥n l√≥gica).
</ParamField>

<ParamField path="car_number" type="TEXT">
N√∫mero interno del veh√≠culo asignado por la empresa (ej: "V-001", "Cami√≥n 15").
</ParamField>

<ParamField path="license_plate" type="TEXT">
Placa oficial del veh√≠culo (ej: "ABC123"). Usado para matching con cargos de peaje.
</ParamField>

<ParamField path="car_title" type="TEXT">
Descripci√≥n o nombre personalizado del veh√≠culo.
</ParamField>

<ParamField path="car_type" type="TEXT">
Tipo principal del veh√≠culo (ej: "Cami√≥n", "Autom√≥vil", "Motocicleta").
</ParamField>

<ParamField path="sub_type" type="TEXT">
Subtipo espec√≠fico (ej: "Cami√≥n R√≠gido", "Sed√°n", "SUV").
</ParamField>

<ParamField path="sim_phone" type="TEXT">
N√∫mero telef√≥nico del SIM card del dispositivo GPS (para comunicaci√≥n directa).
</ParamField>

<ParamField path="fetch_timestamp" type="TIMESTAMP">
√öltima vez que se sincroniz√≥ la informaci√≥n del veh√≠culo desde ERM Karma.
</ParamField>
</Tab>

<Tab title="Categor√≠as de Veh√≠culos">
Los veh√≠culos se clasifican en categor√≠as para determinar las tarifas de peaje:

<CardGroup cols={3}>
<Card title="Categor√≠a 1" icon="car">
**Autom√≥viles**
- Sed√°n, Hatchback
- SUV peque√±os
- Motocicletas

*Tarifa m√°s baja*
</Card>

<Card title="Categor√≠a 2" icon="truck">
**Camionetas**
- Pickup
- SUV grandes
- Furgonetas

*Tarifa media-baja*
</Card>

<Card title="Categor√≠a 3" icon="bus">
**Buses y Camiones Peque√±os**
- Bus intermunicipal
- Cami√≥n r√≠gido 2 ejes
- Furg√≥n grande

*Tarifa media*
</Card>
</CardGroup>

<CardGroup cols={2}>
<Card title="Categor√≠a 4" icon="truck">
**Camiones Medianos**
- Cami√≥n r√≠gido 3+ ejes
- Tractomula sencilla

*Tarifa media-alta*
</Card>

<Card title="Categor√≠a 5" icon="truck">
**Camiones Pesados**
- Tractomula con remolque
- Veh√≠culos especiales

*Tarifa m√°s alta*
</Card>
</CardGroup>

<Warning>
La categor√≠a correcta es fundamental para la validaci√≥n de montos. Una categor√≠a incorrecta resultar√° en alertas de "cobro mayor" o "cobro menor".
</Warning>
</Tab>
</Tabs>

### 4. Asignaciones de Tags

<Tabs>
<Tab title="Estructura">
```sql
tag_assignments {
  id: BIGINT (Primary Key)
  date: DATE
  tag_number: INTEGER
  car_id: BIGINT (FK ‚Üí cars.car_id)
  category: INTEGER (1-5)
  type: TEXT (corporativo|prepago)
  issued_at: DATE
  expires_at: DATE
  status: TEXT (Valido|Inhabilitado)
  created_at: TIMESTAMP
  updated_at: TIMESTAMP
  org_id: UUID (FK ‚Üí organizations.id)
}
```

**Prop√≥sito**: Define qu√© tag est√° asignado a cada veh√≠culo en un per√≠odo espec√≠fico.
</Tab>

<Tab title="Gesti√≥n de Asignaciones">
<Steps>
<Step title="Asignaci√≥n Inicial">
Cuando se asigna un tag nuevo a un veh√≠culo:

- Se crea un registro con fecha de inicio
- El tag debe estar en estado "V√°lido"
- La categor√≠a debe coincidir con el tipo de veh√≠culo
- Solo un tag por veh√≠culo a la vez

<Check>
El sistema valida que no existan conflictos de asignaci√≥n.
</Check>
</Step>

<Step title="Cambio de Asignaci√≥n">
Para reasignar un tag a otro veh√≠culo:

- Se marca la asignaci√≥n anterior como terminada
- Se crea una nueva asignaci√≥n con fecha de inicio
- Se mantiene el historial completo para auditor√≠a

<Warning>
Los cargos hist√≥ricos siguen vinculados a las asignaciones vigentes en su momento.
</Warning>
</Step>

<Step title="Inhabilitaci√≥n">
Cuando un tag se pierde o da√±a:

- Se cambia el estado a "Inhabilitado"
- Se registra la fecha de inhabilitaci√≥n
- Los cargos posteriores a esta fecha se marcan como sospechosos

<Note>
La inhabilitaci√≥n no elimina el historial, solo previene uso futuro.
</Note>
</Step>
</Steps>
</Tab>

<Tab title="Estados y Tipos">
### Estados de Tag

<Tabs>
<Tab title="V√°lido">
**Descripci√≥n**: Tag activo y funcional.

**Caracter√≠sticas**:
- Permite paso por estaciones de peaje
- Genera cargos normales
- Validaciones GPS funcionan correctamente

**Indicador**: üü¢ Verde
</Tab>

<Tab title="Inhabilitado">
**Descripci√≥n**: Tag desactivado por p√©rdida, da√±o o fraude.

**Caracter√≠sticas**:
- No deber√≠a generar cargos nuevos
- Cargos posteriores a inhabilitaci√≥n son sospechosos
- Requiere reemplazo f√≠sico del dispositivo

**Indicador**: üî¥ Rojo
</Tab>
</Tabs>

### Tipos de Tag

<CardGroup cols={2}>
<Card title="Corporativo" icon="building">
**Caracter√≠sticas**:
- Facturaci√≥n mensual posterior
- L√≠mite de cr√©dito alto
- Gesti√≥n centralizada por la empresa
- Reportes detallados disponibles

**Ventajas**: Mejor control y reportes
</Card>

<Card title="Prepago" icon="credit-card">
**Caracter√≠sticas**:
- Saldo precargado
- Funciona hasta agotar saldo
- Recarga manual necesaria
- Control de gastos autom√°tico

**Ventajas**: Control de presupuesto estricto
</Card>
</CardGroup>
</Tab>
</Tabs>

### 5. Estaciones de Peaje

<Tabs>
<Tab title="Estructura">
```sql
tolls {
  id: BIGINT (Primary Key)
  name: TEXT
  latitude: DECIMAL(10,8)
  longitude: DECIMAL(11,8)
  category_1: BIGINT
  category_2: BIGINT
  category_3: BIGINT
  category_4: BIGINT
  category_5: BIGINT
  image: TEXT
  org_id: UUID (FK ‚Üí organizations.id)
}
```

**Prop√≥sito**: Cat√°logo de estaciones de peaje con ubicaci√≥n exacta y tarifas oficiales por categor√≠a.
</Tab>

<Tab title="Informaci√≥n Geogr√°fica">
### Precisi√≥n de Coordenadas

<Note>
Las coordenadas se almacenan con alta precisi√≥n (8 decimales para latitud, 11 para longitud) para garantizar validaciones GPS exactas.
</Note>

**Precisi√≥n alcanzada**:
- **Latitud**: ¬±1.1 metros aproximadamente
- **Longitud**: ¬±1.1 metros en el ecuador
- **Radio de validaci√≥n**: Configurable (500m por defecto)

### Ejemplos de Estaciones

<AccordionGroup>
<Accordion title="Peaje Autopista Norte">
**Ubicaci√≥n**: Km 45 Autopista Norte
- **Latitud**: 4.7110000
- **Longitud**: -74.0721000
- **Categor√≠a 1**: $5,000
- **Categor√≠a 2**: $8,000
- **Categor√≠a 3**: $12,000
- **Categor√≠a 4**: $16,000
- **Categor√≠a 5**: $20,000
</Accordion>

<Accordion title="Peaje La Caro">
**Ubicaci√≥n**: Autopista Norte Km 32
- **Latitud**: 4.8234567
- **Longitud**: -74.0456789
- **Categor√≠a 1**: $4,500
- **Categor√≠a 2**: $7,200
- **Categor√≠a 3**: $10,800
- **Categor√≠a 4**: $14,400
- **Categor√≠a 5**: $18,000
</Accordion>
</AccordionGroup>
</Tab>

<Tab title="Tarifas y Validaci√≥n">
### Estructura de Tarifas

Las tarifas se almacenan por categor√≠a de veh√≠culo:

<ParamField path="category_1" type="BIGINT">
Tarifa para autom√≥viles y motocicletas (categor√≠a m√°s econ√≥mica).
</ParamField>

<ParamField path="category_2" type="BIGINT">
Tarifa para camionetas y SUV.
</ParamField>

<ParamField path="category_3" type="BIGINT">
Tarifa para buses y camiones peque√±os.
</ParamField>

<ParamField path="category_4" type="BIGINT">
Tarifa para camiones medianos.
</ParamField>

<ParamField path="category_5" type="BIGINT">
Tarifa para camiones pesados y veh√≠culos especiales.
</ParamField>

### Proceso de Validaci√≥n de Categor√≠a

<Steps>
<Step title="Identificar Veh√≠culo">
El sistema identifica el veh√≠culo asociado al tag del cargo.
</Step>

<Step title="Determinar Categor√≠a">
Bas√°ndose en el tipo de veh√≠culo, determina la categor√≠a correcta (1-5).
</Step>

<Step title="Consultar Tarifa Oficial">
Busca la tarifa oficial de la estaci√≥n para esa categor√≠a.
</Step>

<Step title="Comparar Montos">
Compara el monto cobrado vs. el monto esperado:
- **Iguales**: ‚úÖ Correcto
- **Cobrado > Esperado**: ‚ùå Cobro excesivo
- **Cobrado < Esperado**: ‚ö†Ô∏è Cobro menor (favorable)
</Step>
</Steps>
</Tab>
</Tabs>

### 6. Cargos de Peaje

<Tabs>
<Tab title="Estructura">
```sql
toll_charges {
  id: BIGINT (Primary Key)
  date: TIMESTAMP
  amount: DOUBLE PRECISION
  tag: BIGINT
  station: TEXT
  type: TEXT
  matched_message_id: BIGINT
  is_duplicate: BOOLEAN
  duplicate_resolution: TEXT
  category_error: BOOLEAN
  expected_amount: DOUBLE PRECISION
  amount_difference: DOUBLE PRECISION
  tag_status_at_time: TEXT
  tag_status_error: BOOLEAN
  fraud_type: TEXT
  fraud_reasons: TEXT
  is_fraudulent: BOOLEAN
  fleet: TEXT
  validation_status: TEXT
  validation_details: TEXT
  matched_car_id: BIGINT (FK ‚Üí cars.car_id)
  matched_license_plate: TEXT
  assignment_date_used: DATE
  distance_meters: DOUBLE PRECISION
  time_diff_minutes: DOUBLE PRECISION
  manual_revision_status: TEXT
  manual_revision_comment: TEXT
  created_at: TIMESTAMP
  updated_at: TIMESTAMP
  org_id: UUID (FK ‚Üí organizations.id)
}
```

**Prop√≥sito**: Registro central de todos los cargos de peaje con sus validaciones y estados.
</Tab>

<Tab title="Campos de Validaci√≥n">
### Validaci√≥n GPS

<ParamField path="validation_status" type="TEXT">
Estado principal de validaci√≥n GPS: VALIDO, UBICACION_INVALIDA, SIN_TELEMETRIA.
</ParamField>

<ParamField path="validation_details" type="TEXT">
Explicaci√≥n detallada del resultado de validaci√≥n (ej: "Veh√≠culo a 1.2km de la estaci√≥n").
</ParamField>

<ParamField path="matched_message_id" type="BIGINT">
ID del mensaje GPS que coincide temporalmente con el cargo.
</ParamField>

<ParamField path="distance_meters" type="DOUBLE PRECISION">
Distancia calculada entre la posici√≥n del veh√≠culo y la estaci√≥n de peaje.
</ParamField>

<ParamField path="time_diff_minutes" type="DOUBLE PRECISION">
Diferencia de tiempo entre el cargo y el mensaje GPS m√°s cercano.
</ParamField>

### Validaci√≥n de Duplicados

<ParamField path="is_duplicate" type="BOOLEAN">
Indica si se detect√≥ otro cargo similar (mismo tag, estaci√≥n, tiempo similar).
</ParamField>

<ParamField path="duplicate_resolution" type="TEXT">
Explicaci√≥n de por qu√© se considera duplicado y qu√© acci√≥n tomar.
</ParamField>

### Validaci√≥n de Categor√≠a

<ParamField path="category_error" type="BOOLEAN">
Indica si hay discrepancia entre el monto cobrado y el esperado.
</ParamField>

<ParamField path="expected_amount" type="DOUBLE PRECISION">
Monto que deber√≠a haberse cobrado seg√∫n la categor√≠a del veh√≠culo.
</ParamField>

<ParamField path="amount_difference" type="DOUBLE PRECISION">
Diferencia entre monto cobrado y esperado (positivo = cobro excesivo).
</ParamField>

### Validaci√≥n de Tags

<ParamField path="tag_status_at_time" type="TEXT">
Estado del tag en el momento del cargo (V√°lido, Inhabilitado).
</ParamField>

<ParamField path="tag_status_error" type="BOOLEAN">
Indica si el tag estaba inhabilitado cuando se gener√≥ el cargo.
</ParamField>
</Tab>

<Tab title="Estados de Cargo">
### Ciclo de Vida de un Cargo

<Steps>
<Step title="Importaci√≥n">
**Estado inicial**: Sin validar
- Datos b√°sicos: fecha, tag, estaci√≥n, monto
- Todos los campos de validaci√≥n est√°n vac√≠os
- Requiere procesamiento para determinar estado final

<Note>
Los cargos se importan desde archivos CSV proporcionados por las concesionarias.
</Note>
</Step>

<Step title="Matching con Veh√≠culos">
**Proceso**: Asociaci√≥n con flota
- Se busca la asignaci√≥n de tag vigente en la fecha del cargo
- Se identifica el veh√≠culo correspondiente
- Se establece el contexto para validaciones

<Warning>
Si no se encuentra asignaci√≥n v√°lida, el cargo queda como "hu√©rfano" y requiere revisi√≥n.
</Warning>
</Step>

<Step title="Validaci√≥n Autom√°tica">
**Proceso**: Ejecuci√≥n de 4 validaciones
1. **GPS**: Confirma presencia del veh√≠culo
2. **Duplicados**: Detecta cargos repetidos
3. **Categor√≠a**: Verifica monto correcto
4. **Tag**: Confirma estado activo

<Check>
Cada validaci√≥n actualiza campos espec√≠ficos con resultados detallados.
</Check>
</Step>

<Step title="Revisi√≥n Manual (Opcional)">
**Proceso**: Intervenci√≥n humana
- Analista revisa casos sospechosos
- Puede aprobar, rechazar o solicitar m√°s informaci√≥n
- Agrega comentarios explicativos

<Tip>
La revisi√≥n manual es especialmente importante para cargos con m√∫ltiples validaciones fallidas.
</Tip>
</Step>

<Step title="Estado Final">
**Resultado**: Cargo procesado
- Estado de validaci√≥n definitivo
- Recomendaci√≥n de acci√≥n (pagar, reclamar, investigar)
- Documentaci√≥n completa para auditor√≠a

<Info>
Los cargos finalizados se incluyen en reportes y an√°lisis de costos.
</Info>
</Step>
</Steps>
</Tab>
</Tabs>

### 7. Datos de Telemetr√≠a GPS

<Tabs>
<Tab title="Estructura">
```sql
edata_telemetry {
  car_id: BIGINT (FK ‚Üí cars.car_id)
  device_id: BIGINT
  car_number: TEXT
  message_id: BIGINT
  edt: TIMESTAMP
  edt_tz: TEXT
  pdt: TEXT
  speed_kph: DOUBLE PRECISION
  odometer_km: DOUBLE PRECISION
  latitude: DOUBLE PRECISION
  longitude: DOUBLE PRECISION
  fetch_timestamp: TIMESTAMP
  batch_number: BIGINT
  org_id: UUID (FK ‚Üí organizations.id)
}
```

**Prop√≥sito**: Almacena datos de telemetr√≠a GPS obtenidos desde ERM Karma para validaciones de ubicaci√≥n.
</Tab>

<Tab title="Sincronizaci√≥n con ERM Karma">
### Proceso de Obtenci√≥n de Datos

<Steps>
<Step title="Solicitud Autom√°tica">
**Trigger**: Importaci√≥n de nuevos cargos
- Sistema identifica fechas de cargos sin validar
- Calcula ventana de tiempo necesaria (¬±2 horas por cargo)
- Solicita datos GPS a ERM Karma API

<Note>
La sincronizaci√≥n es autom√°tica pero puede ejecutarse manualmente si es necesario.
</Note>
</Step>

<Step title="Descarga por Lotes">
**Optimizaci√≥n**: Descarga eficiente
- Agrupa solicitudes por veh√≠culo y rango de fechas
- Procesa en lotes de hasta 1000 registros
- Maneja reintentos autom√°ticos en caso de falla

<Check>
Los datos se almacenan localmente para evitar solicitudes repetidas.
</Check>
</Step>

<Step title="Validaci√≥n de Calidad">
**Control**: Verificaci√≥n de datos
- Valida coordenadas dentro de rangos geogr√°ficos v√°lidos
- Descarta registros con velocidades imposibles
- Marca registros con posibles errores de GPS

<Warning>
Datos GPS de mala calidad pueden afectar la precisi√≥n de las validaciones.
</Warning>
</Step>
</Steps>
</Tab>

<Tab title="Uso en Validaciones">
### Algoritmo de Validaci√≥n GPS

<AccordionGroup>
<Accordion title="Paso 1: B√∫squeda Temporal">
**Objetivo**: Encontrar mensajes GPS cercanos al momento del cargo

**Proceso**:
- Busca mensajes GPS en ventana de ¬±1 minuto (configurable)
- Si no encuentra, expande a ¬±5 minutos
- Ordena por proximidad temporal

**Criterio de √©xito**: Al menos 1 mensaje GPS en ventana de tiempo
</Accordion>

<Accordion title="Paso 2: C√°lculo de Distancia">
**Objetivo**: Medir distancia entre veh√≠culo y estaci√≥n

**F√≥rmula**: Distancia haversine entre coordenadas GPS
```
d = 2 * r * arcsin(‚àö(sin¬≤((lat2-lat1)/2) + cos(lat1) * cos(lat2) * sin¬≤((lon2-lon1)/2)))
```

**Criterio de √©xito**: Distancia ‚â§ 500 metros (configurable)
</Accordion>

<Accordion title="Paso 3: Validaci√≥n de Coherencia">
**Objetivo**: Verificar que los datos sean l√≥gicamente coherentes

**Verificaciones**:
- Velocidad dentro de rangos normales (0-120 km/h)
- Secuencia temporal coherente
- Ubicaci√≥n geogr√°ficamente posible

**Criterio de √©xito**: Todos los checks de coherencia pasan
</Accordion>

<Accordion title="Paso 4: Clasificaci√≥n Final">
**Resultado**: Asignaci√≥n de estado de validaci√≥n

**Estados posibles**:
- **VALIDO**: Todas las validaciones exitosas
- **UBICACION_INVALIDA**: Distancia > umbral permitido
- **SIN_TELEMETRIA**: No hay datos GPS disponibles

**Documentaci√≥n**: Se registran todos los detalles para auditor√≠a
</Accordion>
</AccordionGroup>
</Tab>
</Tabs>

## Relaciones Entre Entidades

### Diagrama de Relaciones

```mermaid
graph TD
    A[Organizations] --> B[org_members]
    A --> C[cars]
    A --> D[projects]
    A --> E[toll_charges]
    A --> F[tag_assignments]
    A --> G[tolls]
    A --> H[edata_telemetry]
    
    C --> F
    C --> E
    C --> H
    D --> C
    
    F --> E
    G --> E
    H --> E
    
    B --> I[auth.users]
```

### Flujo de Datos Principal

<Steps>
<Step title="Configuraci√≥n Inicial">
**Entidades**: Organizations, Users, Cars, Projects
- Se crea la organizaci√≥n y usuarios
- Se importan veh√≠culos y proyectos desde ERM Karma
- Se configura la integraci√≥n API

<Check>
Base de datos preparada para operaci√≥n.
</Check>
</Step>

<Step title="Gesti√≥n de Tags">
**Entidades**: tag_assignments, cars
- Se asignan tags a veh√≠culos espec√≠ficos
- Se define categor√≠a y per√≠odo de vigencia
- Se mantiene historial de cambios

<Note>
Las asignaciones correctas son cr√≠ticas para validaciones precisas.
</Note>
</Step>

<Step title="Importaci√≥n de Cargos">
**Entidades**: toll_charges, tolls
- Se importan cargos desde archivos CSV
- Se asocian con estaciones conocidas
- Se inicia proceso de validaci√≥n

<Warning>
Cargos de estaciones desconocidas requieren configuraci√≥n adicional.
</Warning>
</Step>

<Step title="Validaci√≥n Autom√°tica">
**Entidades**: edata_telemetry, toll_charges
- Se obtienen datos GPS relevantes
- Se ejecutan algoritmos de validaci√≥n
- Se actualizan estados y resultados

<Tip>
El proceso es autom√°tico pero puede monitorearse en tiempo real.
</Tip>
</Step>

<Step title="Revisi√≥n y Reportes">
**Entidades**: toll_charges (estados finales)
- Se revisan casos sospechosos manualmente
- Se generan reportes ejecutivos
- Se documentan decisiones para auditor√≠a

<Info>
Los reportes pueden exportarse a Excel para an√°lisis adicional.
</Info>
</Step>
</Steps>

## Integridad y Consistencia

### Restricciones de Negocio

<AccordionGroup>
<Accordion title="Unicidad de Tags">
**Regla**: Un tag solo puede estar asignado a un veh√≠culo a la vez

**Implementaci√≥n**: 
- Constraint √∫nico en (tag_number, org_id)
- Validaci√≥n de fechas de asignaci√≥n sin solapamiento
- Proceso de reasignaci√≥n controlado

**Excepci√≥n**: Tags inhabilitados pueden reasignarse despu√©s de reemplazo f√≠sico
</Accordion>

<Accordion title="Consistencia Temporal">
**Regla**: Los cargos solo pueden validarse con datos GPS contempor√°neos

**Implementaci√≥n**:
- Ventana de tiempo configurable para matching
- Validaci√≥n de timestamps coherentes
- Manejo de zonas horarias

**Consideraci√≥n**: Diferencias de reloj entre sistemas pueden requerir ajustes
</Accordion>

<Accordion title="Aislamiento de Organizaciones">
**Regla**: Los datos de una organizaci√≥n nunca deben ser visibles para otra

**Implementaci√≥n**:
- Row Level Security (RLS) en todas las tablas
- Filtrado autom√°tico por org_id
- Validaci√≥n de permisos en cada consulta

**Garant√≠a**: Seguridad certificada a nivel de base de datos
</Accordion>
</AccordionGroup>

### Pol√≠ticas de Retenci√≥n

<Tabs>
<Tab title="Datos Operativos">
**Per√≠odo**: 2 a√±os m√≠nimo
- Cargos de peaje y validaciones
- Datos GPS de telemetr√≠a
- Asignaciones de tags

**Justificaci√≥n**: Auditor√≠a, an√°lisis hist√≥rico, disputas legales
</Tab>

<Tab title="Logs de Sistema">
**Per√≠odo**: 6 meses
- Logs de importaci√≥n
- Registros de validaci√≥n
- Errores y excepciones

**Justificaci√≥n**: Troubleshooting, optimizaci√≥n de procesos
</Tab>

<Tab title="Reportes Generados">
**Per√≠odo**: Permanente
- Reportes ejecutivos mensuales
- An√°lisis de fraudes
- Documentaci√≥n de decisiones

**Justificaci√≥n**: Hist√≥rico empresarial, compliance regulatorio
</Tab>
</Tabs>

## Pr√≥ximos Pasos

<CardGroup cols={2}>
<Card title="Sistema de Validaci√≥n" icon="shield" href="/validacion-sistema">
Aprende c√≥mo funcionan los algoritmos de validaci√≥n en detalle
</Card>
<Card title="Gu√≠a del Usuario" icon="user" href="/guia-usuario">
Instrucciones pr√°cticas para operar el sistema d√≠a a d√≠a
</Card>
</CardGroup> 